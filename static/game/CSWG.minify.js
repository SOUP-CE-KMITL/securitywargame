var PlayScene={scene:null,worldMap:null,cityMap:null,graph:null,wayKey:null,comment:null,detectIcon:null,turnText:null,cursor:null,activeLevel:0,activeLevelText:null,score:0,scoreText:null,atkQueue:[],stat:null,mapID:0,load:function(a){var b=JSON.parse(callAPI("POST","/create-waypoint","mapID="+a.mapID+"&playerID="+getCookie("user_id")));this.graph=new Graph(JSON.parse(b.graphStat));this.wayKey=b.waypointsID;this.mapID=b.mapID;this.score=b.score;this.atkQueue=[];a=new createjs.Container;var c=new createjs.Container,
d=new createjs.Container;this.scene=new createjs.Container;stage.addChild(this.scene);this.scene.addChild(a);this.scene.addChild(c);this.scene.addChild(d);this.worldMap=a;this.cityMap=c;createjs.Sound.play("play-bgm",{loop:-1});var e=new createjs.Shape;e.graphics.f("white").mt(-10,10).lt(-10,-10).lt(0,-10).lt(20,-25).lt(20,25).lt(0,10).lt(-10,10);EffectMaster.addButtonEffect(e);e.on("click",function(a){createjs.Sound.setMute(!createjs.Sound.getMute());e.graphics.f(createjs.Sound.getMute()?"gray":
"white").mt(-10,10).lt(-10,-10).lt(0,-10).lt(20,-25).lt(20,25).lt(0,10).lt(-10,10)},this);e.x=970;e.y=180;d.addChild(e);var f=new createjs.Shape;f.width=1024;f.height=768;f.graphics.bf(myItems["bg-grass"]).r(0,0,1024,768);a.addChild(f);for(f=0;4>f;f++){var g=Math.floor(2*Math.random()+1);drawBitMap(a,myItems["bg-mt"+g],568*Math.random()+100,500*Math.random()+100,100,100)}g=new createjs.Bitmap(myItems["bg-city"]);g.scaleX=g.scaleY=2;g.addEventListener("click",function(){});c.addChild(g);c.visible=
!1;var k=new createjs.Bitmap("resource/icon/Icon-back.png");k.x=980;k.y=500;k.on("mouseover",function(a){createjs.Tween.get(k,{override:!0}).to({x:960},500,createjs.Ease.getBackIn(2.5))});k.on("mouseout",function(a){createjs.Tween.get(k,{override:!0}).to({x:980},500,createjs.Ease.getBackIn(2.5))});k.addEventListener("click",function(a){createjs.Tween.get(c).to({scaleX:0,scaleY:0,x:PlayScene.currentCity.sprite.x,y:PlayScene.currentCity.sprite.y},500,createjs.Ease.getBackIn(3)).call(function(){c.visible=
!1});PlayScene.cursor.x=-100;ActionPane.container.removeAllChildren()});c.addChild(k);c.symbolLayer=new createjs.Container;c.addChild(c.symbolLayer);f=new createjs.Container;d.addChild(f);g=new createjs.Bitmap("resource/UI/InspecWin.png");g.y=600;f.addChild(g);g=new createjs.Container;drawBitMap(g,"resource/base.png",50,620);g.on("click",function(a){PlayScene.endGame("retire")},this);f.addChild(g);f.stat=new createjs.Text("","18px arial","#FFFFFF");f.addChild(f.stat);f.stat.x=400;f.stat.y=620;this.stat=
f.stat;drawBitMap(d,"resource/UI/TopBar.png",0,0);this.comment=new createjs.Text("Choose city to explore.","18px arial","#FFFFFF");d.addChild(this.comment);this.comment.x=10;this.comment.y=558;g=new createjs.SpriteSheet({images:["resource/icon/icon-detect-guage.png"],frames:{width:64,height:64,regX:32,regY:32,count:9}});this.detectIcon=new createjs.Sprite(g);this.detectIcon.x=512;this.detectIcon.y=32;d.addChild(this.detectIcon);this.detectIcon.addEventListener("mouseover",function(){PlayScene.comment.text=
"Detection level."});g=new createjs.Bitmap("resource/icon/TimeIcon.png");d.addChild(g);g.x=920;g.y=10;g.addEventListener("mouseover",function(){PlayScene.comment.text="Turn."});this.turnText=new createjs.Text(b.savedTurn||"0","18px arial","#FFFFFF");d.addChild(this.turnText);this.turnText.x=970;this.turnText.y=15;this.cursor=new createjs.Bitmap("resource/target.png");d.addChild(this.cursor);this.cursor.x=-100;this.cursor.y=-100;this.cursor.regX=32;this.cursor.regY=32;createjs.Tween.get(this.cursor,
{loop:!0}).to({scaleX:1.2,scaleY:1.2},500).to({scaleX:1,scaleY:1},500);b=new createjs.Bitmap("resource/UI/NextTurn.png");d.addChild(b);b.x=980;b.y=620;b.addEventListener("click",PlayScene.Launch);b.addEventListener("mouseover",function(){PlayScene.comment.text="Next step."});ActionPane.Init(f);QueueList.Init(d);this.activeLevel=0;this.activeLevelText=new createjs.Text("0","18px arial","#FFF");d.addChild(this.activeLevelText);this.activeLevelText.x=512;this.activeLevelText.y=21;this.activeLevelText.textAlign=
"center";f=new createjs.Bitmap("resource/icon/MoneyIcon.png");d.addChild(f);f.x=10;f.y=10;f.addEventListener("mouseover",function(){PlayScene.comment.text="Score."});this.scoreText=new createjs.Text(this.score,"18px arial","#FFF");d.addChild(this.scoreText);this.scoreText.x=60;this.scoreText.y=15;this.helpScr=new createjs.Bitmap(myItems.help);this.helpScr.on("click",function(a){},this);d.addChild(this.helpScr);this.helpScr.visible=!1;this.helpBtn=new createjs.Bitmap("resource/icon/Icon-help.png");
d.addChild(this.helpBtn);this.helpBtn.x=980;this.helpBtn.y=100;this.helpBtn.regX=32;this.helpBtn.regY=32;this.helpBtn.on("click",function(a){this.helpScr.visible=!this.helpScr.visible},this);EffectMaster.addButtonEffect(this.helpBtn);d=[];for(f=0;f<this.graph.machines.length;f++)this.graph.machines[f]&&(d[f]=new City(this.graph.machines[f],this.graph.paths),d[f].Draw(a,244+FILL_POSITION[f]%4*172,105+112*Math.floor(FILL_POSITION[f]/4)));PlayScene.cities=d;for(f=0;100>f;f++)for(b=0;b<d.length;b++)for(g=
0;g<d.length;g++){var h=d[b].sprite,l=d[g].sprite,l=new Vector(l.x-h.x,l.y-h.y),m;m=d[b].IsConnect(d[g])?l.unit().multiply(80):l.unit().multiply(120);l=l.divide(3).subtract(m);h.x+=l.x;h.y+=l.y}for(b=f=sy=0;b<d.length;b++)f+=d[b].sprite.x,sy+=d[b].sprite.y;f/=d.length;sy/=d.length;f-=512;g=sy-324;for(b=0;b<d.length;b++)d[b].sprite.x-=f,d[b].sprite.y-=g,d[b].sprite.x=Math.max(50,Math.min(d[b].sprite.x,950)),d[b].sprite.y=Math.max(100,Math.min(d[b].sprite.y,684));for(f=0;f<d.length;f++){d[f].DrawLink(a);
g=!1;for(b=0;b<d[f].services.length&&d[f].services[b].captured;b++)g=!0;g&&(b=new createjs.SpriteSheet({images:[myItems["char-flag"]],frames:{width:64,height:64,regX:32,regY:64,count:2},animations:{"default":[0,1,"default",.5]}}),b=new createjs.Sprite(b,"default"),b.x=d[f].sprite.x+24,b.y=d[f].sprite.y,a.addChild(b))}a.addEventListener("mousedown",function(a){a.currentTarget.px=a.localX;a.currentTarget.py=a.localY})},erase:function(a){a.removeChild(this.scene)},Launch:function(){var a=PlayScene;a.turnText.text=
parseInt(a.turnText.text,10)+1;0==a.atkQueue.length&&--PlayScene.activeLevel;if(8<=a.activeLevel)PlayScene.endGame("detected");else{for(var b=!0,c=0;c<PlayScene.cities.length;c++)for(var d=0;d<PlayScene.cities[c].services.length;d++)if(!PlayScene.cities[c].services[d].captured){b=!1;break}b&&PlayScene.endGame("Win");for(c=0;c<a.atkQueue.length;c++)if(a.atkQueue[c].start+a.atkQueue[c].dur==parseInt(a.turnText.text,10)){addStep(a.atkQueue[c]);var e=a.atkQueue[c].soldier,b=0;if("explorer"==e.name){PlayScene.activeLevel+=
1;var f=e.city.machine;f.status="ready";e.city.sprite.gotoAndPlay("level"+Math.ceil(e.city.services.length/2));e.Erase();b=5;e.city.DrawLink(PlayScene.worldMap)}else if("occupier"!=e.name&&"occupy"!=e.name)if("Picklocker"==e.name)PlayScene.activeLevel+=3,f=Math.random(),.5>f?(e.forPath.keyHeld+=1,PlayScene.comment.text="Picklocking success.",b=10):PlayScene.comment.text="Picklocking fails.";else if("Locksmith"==e.name)PlayScene.activeLevel+=1,f=Math.random(),.9>f?(e.forPath.keyHeld+=1,PlayScene.comment.text=
"Key coppied.",b=10):PlayScene.comment.text="Can't coppy the key.";else{f=PlayScene.graph._mDict[PlayScene.graph._sDict[e.edge.dest].machineID];f.status="ready";e.edge.status="used";createjs.Sound.play("end-sfx");PlayScene.activeLevel+=1;if(1==e.integrity)var g=PlayScene.graph._sDict[e.edge.dest],b=b+Building.Capture(g,e);else if(2==e.integrity){f=City.getCityById(PlayScene.cities,e.to);for(d=0;d<f.services.length;d++)g=PlayScene.graph._sDict[f.services[d].serviceID],b+=Building.Capture(g,e);f.Spread();
f.DrawLink(PlayScene.worldMap);d=new createjs.SpriteSheet({images:[myItems["char-flag"]],frames:{width:64,height:64,regX:32,regY:64,count:2},animations:{"default":[0,1,"default",.5]}});d=new createjs.Sprite(d,"default");d.x=f.sprite.x+24;d.y=f.sprite.y;PlayScene.worldMap.addChild(d)}b+=SCORE_SYSTEM.av[e.vector];b+=SCORE_SYSTEM.ac[e.level];b+=SCORE_SYSTEM.au[e.authen]}0<b&&(PlayScene.score+=b,PlayScene.scoreText.text=PlayScene.score,callAPI("POST","/update-score","waypoint="+PlayScene.wayKey+"&score="+
PlayScene.score+"&graphStat="+JSON.stringify(PlayScene.graph)+"&currentTurn="+PlayScene.turnText.text));PlayScene.cityMap&&createjs.Tween.get(e.sprite,{override:!0}).to({scaleX:0,scaleY:0},300).call(function(a){PlayScene.cityMap.removeChild(e.sprite)});e.sprite?EffectMaster.Explode(PlayScene.cityMap,e.sprite.x,e.sprite.y):EffectMaster.Explode(PlayScene.worldMap,PlayScene.currentCity.sprite.x,PlayScene.currentCity.sprite.y);a.atkQueue.splice(c,1);c--}8<PlayScene.activeLevel&&(PlayScene.activeLevel=
8);0>=PlayScene.activeLevel&&(PlayScene.activeLevel=0);PlayScene.activeLevelText.text=PlayScene.activeLevel;PlayScene.detectIcon.gotoAndStop(PlayScene.activeLevel);for(c=0;c<QueueList.names.length;c++)--QueueList.remTurns[c].text;QueueList.Remove()}},endGame:function(a){SceneManager.changeScene(EndScene,{mapID:this.mapID,reason:a.toUpperCase()});var b=PlayScene;callAPI("POST","/end-game","wpid="+b.wayKey+"&score="+b.score+"&turn="+b.turnText.text+"&reason="+a)}};ActionPane={Init:function(a){ActionPane.container=new createjs.Container;ActionPane.actions=[];a.addChild(ActionPane.container);return ActionPane.container},SetActions:function(a){ActionPane.container.removeAllChildren();for(var b=0;b<a.length;b++)ActionPane.actions[b]={},ActionPane.actions[b].img=new createjs.Bitmap(a[b].img),"explorer"==a[b].soldier.name?(ActionPane.actions[b].img.addEventListener("mouseover",Explorer.ShowInfo),ActionPane.actions[b].img.addEventListener("click",Explorer.Action)):
(ActionPane.actions[b].img.addEventListener("mouseover",Soldier.ShowInfo),ActionPane.actions[b].img.addEventListener("click",Soldier.Action),PlayScene.graph._sDict[a[b].soldier.edge.src].captured||(ActionPane.actions[b].img.alpha=.5)),ActionPane.actions[b].img.x=700+b%4*72,ActionPane.actions[b].img.y=620+72*Math.floor(b/4),ActionPane.actions[b].img.ref=a[b].soldier,ActionPane.actions[b].img.scaleX=.01,ActionPane.actions[b].img.scaleY=.01,ActionPane.actions[b].img.actionOf=a[b].actionOf,createjs.Tween.get(ActionPane.actions[b].img,
{override:!0}).wait(250*b).to({scaleX:1,scaleY:1},500,createjs.Ease.backOut),ActionPane.container.addChild(ActionPane.actions[b].img)}};var SCORE_SYSTEM={av:[100,64,39,39],ac:[35,61,71,71],au:[45,56,70,70],ci:[0,27,66],ii:[0,27,66],ai:[0,27,66]},SERVICE_DICT={os:"Headquater",db:"Warehouse",mysql:"Warehouse",web:"Trade port",www:"Trade port",http:"Trade port",https:"Trade port",ssh:"Barrack",firewall:"Turret",fw:"Turret",ftp:"Barrack"},CWE_DICT={bypass:"Hunter",injection:"Hypnotist",what:"Arai"},RANDOM_NAME="Spc.Peter Spc.Sean Spc.David Spc.Micheal Spc.John Spc.Johny Spc.Dave Spc.Leo Spc.Bobby Spc.Justin Spc.Jaden Spc.Jeff Spc.Mike Spc.Mark Spc.Albert Spc.Stephen Spc.Jonathan Spc.Robert Spc.Steve Spc.Garfield Spc.Jenny".split(" "),
RANDOM_CITY="St.James;Cyro;Rome;Brookhaven;Black Butte Ranch;Crosbyton;Cedar Vale;Gnadenhutten;Ash Shu\u2018aybah;\u2018Atf Jabara;Aushaziya;Daff Khuz\u0101\u2018ah;Ras at Tannura;Heesfeld;Oelixdorf;Gehrenrode;Tressentin;Buoch".split(";"),FILL_POSITION=[10,9,7,12,4,15,6,13,14,5,8,11,16,17,3,2,1,0,19,18];
function callAPI(a,b,c){var d;d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.open(a,b,!1);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");"POST"==a?d.send(c):d.send();return d.responseText}function drawBitMap(a,b,c,d,e,f){b=new createjs.Bitmap(b);b.x=c;b.y=d;b.regX=e;b.regY=f;a.addChild(b)};function Building(a,b){this.service=a;a.captured=a.captured||!1;this.name=a.name;this.buildingID=a.serviceID;this.sName=SERVICE_DICT[a.name]?SERVICE_DICT[this.name]:"Lab";this.city=b}
Building.prototype.Draw=function(a,b,c){this.sheet=new createjs.SpriteSheet({animations:{"default":[0,0,"default"]},images:["resource/"+this.sName+".png"],frames:{width:512,height:512,regX:256,regY:256,count:1}});this.sprite=new createjs.Sprite(this.sheet,"default");this.sprite.ref=this;this.sprite.scaleX=.25;this.sprite.scaleY=.25;this.sprite.x=b;this.sprite.y=c;a.addChild(this.sprite);this.sprite.gotoAndStop("default");this.sprite.on("mouseover",function(a){createjs.Sound.play("hover-sfx");createjs.Tween.get(this.sprite).to({scaleX:.35,
scaleY:.35},250)},this);this.sprite.on("mouseout",function(a){createjs.Tween.get(this.sprite).to({scaleX:.25,scaleY:.25},250)},this)};Building.ShowInfo=function(a){a=a.target;PlayScene.stat.text="name: "+a.ref.sName+"\ncity: "+a.ref.city.name+"\nstatus: "+a.ref.service.status+"\ncaptured: "+a.ref.service.captured+"\n"};
Building.ShowActions=function(a){createjs.Sound.play("click-sfx");a=a.target.ref;var b=PlayScene.graph.paths;if("found"==a.service.status){for(var c=[],d=0;d<b.length;d++)b[d].dest==a.service.serviceID&&"unused"==b[d].status&&(c[c.length]=b[d]);b=[];for(d=0;d<c.length;d++)b[d]={},b[d].img="resource/icon/Icon-Soldier.png",b[d].soldier=new Soldier(c[d]),b[d].actionOf=a;ActionPane.SetActions(b)}PlayScene.cursor.x=a.sprite.x;PlayScene.cursor.y=a.sprite.y};
Building.Capture=function(a,b){a.captured=!0;var c=0,d=a.impact;if(d.c<b.confident){var e=b.confident-d.c;d.c+=e;c+=SCORE_SYSTEM.ci[e]}d.i<b.integrity&&(e=b.integrity-d.i,d.i+=e,c+=SCORE_SYSTEM.ii[e]);d.a<b.availability&&(e=b.availability-d.a,d.a+=e,c+=SCORE_SYSTEM.ai[e]);return c};function City(a,b){this.machine=a;this.cityID=a.machineID;this.name=RANDOM_CITY[this.cityID%RANDOM_CITY.length];this.to=[];this.services=[];for(var c=0;c<b.length;c++)if(b[c]){var d=PlayScene.graph._sDict[b[c].src].machineID,e=PlayScene.graph._sDict[b[c].dest].machineID;d==a.machineID&&-1==this.to.indexOf(e)&&d!=e&&this.to.push(e)}for(c=0;c<PlayScene.graph.services.length;c++)d=PlayScene.graph.services[c],d.machineID==this.cityID&&this.services.push(d)}
City.getCityById=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.cityID===b)return d}};
City.prototype.Draw=function(a,b,c){this.sheet=new createjs.SpriteSheet({animations:{"default":{frames:[0,1,2,3,2,1]},level1:[4,7,!1],level2:[4,11,!1],level3:[4,15,!1]},images:[myItems["char-city"]],frames:{width:128,height:128,regX:64,regY:96,count:16}});this.sprite=new createjs.Sprite(this.sheet,"default");this.sprite.ref=this;this.sprite.x=b;this.sprite.y=c;a.addChild(this.sprite);"hidden"==this.machine.status?this.sprite.visible=!1:"found"==this.machine.status?this.sprite.gotoAndPlay("default"):
"ready"==this.machine.status&&this.sprite.gotoAndPlay("level"+Math.ceil(this.services.length/2));EffectMaster.addButtonEffect(this.sprite);this.sprite.on("click",City.ClickHandler,this);this.sprite.on("mouseover",City.ShowCityInfo,this)};
City.prototype.drawCityMap=function(a){console.log("Same as the last city: "+(PlayScene.currentCity==this));if(PlayScene.currentCity==this)a.visible=!0;else{a.symbolLayer.removeAllChildren();for(var b=[],c=0;c<this.services.length;c++){b[c]=new Building(this.services[c],this);b[c].Draw(a.symbolLayer,244+FILL_POSITION[c]%4*172,105+112*Math.floor(FILL_POSITION[c]/4));b[c].sprite.addEventListener("mouseover",Building.ShowInfo);b[c].sprite.addEventListener("click",Building.ShowActions);for(var d=0;d<
PlayScene.atkQueue.length;d++){var e=PlayScene.atkQueue[d];e.soldier.edge&&e.soldier.edge.dest==b[c].service.serviceID&&(e.soldier.Draw(a.symbolLayer,b[c].sprite.x,b[c].sprite.y),e.soldier.sprite.gotoAndPlay("default"),b[c].status="attacking")}}a.visible=!0;a.scaleX=0;a.scaleY=0;a.x=this.sprite.x;a.y=this.sprite.y}createjs.Tween.get(a).to({scaleX:1,scaleY:1,x:0,y:0},500,createjs.Ease.getBackIn(3))};
City.prototype.IsConnect=function(a){for(var b=0;b<this.to.length;b++)if(this.to[b]==a.machine.machineID&&a.machine.machineID!=this.machine.machineID)return!0;return!1};City.ClickHandler=function(a){createjs.Sound.play("click-sfx");a=a.target.ref;"found"==a.machine.status?(PlayScene.cursor.x=a.sprite.x,PlayScene.cursor.y=a.sprite.y,a={img:"resource/icon/Icon-Scout.png",soldier:new Explorer(a)},ActionPane.SetActions([a])):(a.drawCityMap(PlayScene.cityMap),PlayScene.currentCity=this)};
City.ShowCityInfo=function(a){a=a.target;var b="",b="name: "+a.ref.name+"\nsize: "+a.ref.services.length+"\nstatus: "+a.ref.machine.status+"\n";PlayScene.stat.text=b};City.prototype.Spread=function(){for(var a=0;a<this.to.length;a++){var b=City.getCityById(PlayScene.cities,this.to[a]);"hidden"==b.machine.status&&(b.machine.status="found",b.sprite.visible=!0)}};
City.prototype.DrawLink=function(a){for(var b=0;b<this.to.length;b++){var c=City.getCityById(PlayScene.cities,this.to[b]);if("ready"==this.machine.status&&c.sprite.visible){var d=new createjs.Shape;d.graphics.ss(2).s("#FFF").mt(this.sprite.x,this.sprite.y).lt(c.sprite.x,c.sprite.y).es();a.addChild(d);a.addChild(this.sprite);a.addChild(c.sprite)}}};EffectMaster={Explode:function(a,b,c,d,e,f,g,k){b=b||512;c=c||384;f=f||20;e=e||100;g=g||5;k=k||10;d=d||1E3;var h=[];for(i=0;i<f;i++)h[i]=new createjs.Shape,h[i].graphics.f("yellow").dp(0,0,k,g,.4,360*Math.random()),a.addChild(h[i]),h[i].x=b,h[i].y=c,createjs.Tween.get(h[i]).to({x:h[i].x+Math.random()*e-e/2,y:h[i].y+Math.random()*e-e/2,rotation:360*Math.random(),alpha:0},d).call(function(b){a.removeChild(b.target)})},addButtonEffect:function(a){a.on("mouseover",EffectMaster.scaleUp,a);a.on("mouseout",
EffectMaster.scaleDown,a)},scaleUp:function(a){createjs.Tween.get(a.target).to({scaleX:1.1,scaleY:1.1},400,createjs.Ease.backOut);createjs.Sound.play("hover-sfx")},scaleDown:function(a){createjs.Tween.get(a.target).to({scaleX:1,scaleY:1},400,createjs.Ease.backIn)}};var EndScene={scene:null,load:function(a){SceneManager.currentScene=this;this.scene=new createjs.Container;createjs.Sound.play("end-bgm",{loop:-1});var b=new createjs.Shape;b.graphics.f("#000").r(0,0,1024,768);this.scene.addChild(b);b=callAPI("GET","/get-highscore?map_id="+a.mapID);b=JSON.parse(b);a=new createjs.Text(a.reason,"48px arial","#6FE");a.x=512;a.y=50;a.textAlign="center";this.scene.addChild(a);for(a=0;a<b.length;a++){var c=new createjs.Text(b[a],"28px arial","#FFF");c.x=512;c.y=140+40*
a;c.textAlign="center";this.scene.addChild(c)}b=new createjs.Text(PlayScene.score,"36px arial","#CA4");b.x=512;b.y=530;b.textAlign="center";this.scene.addChild(b);b=new createjs.Shape;b.graphics.s("#555").f("#DDD").r(-50,-30,100,60).ss(3).s("#333").a(0,0,20,.75*Math.PI,.25*Math.PI).mt(-14,14).f("#333").dc(-13,14,2).dp(14,14,5,3,0,135);b.x=512;b.y=630;this.scene.addChild(b);b.on("click",function(){SceneManager.changeScene(LevelScene)},this);var d="s o E C B Y r k , m D C J c v ; 2 ) L 3 ' l ; v d e a c [ q w e 4 D v 4 * 5 c D{z w p e j k ; O J A ; L K J J ; L K i o j l c q [ 9 0 . m n v i S ^ r e N I ( 0{8 c k e m c e L D N } C + D _ E < l l e k v k r . v 5 8 f I K E k c i K E 9 3 4{f s l D V $ 5 6 k k 2 3 4 f 7 % o i S ^ r e N I ( 0 p o h ^ I G p h I H N l Z W{S S B h b S B 0 a G U g Y m V z d C B w c m 9 n c m F t b W V y E C B Y r k , 9{V G h ? c y B n Y W 1 l I G l z I G Z 1 Y 2 t p b m c g a G F y Z C 4 = ^ x K d{a 3 V 5 ^ I G p h I H N l Z C ( B t a G * k  g b m  V l c g # % W h y a m i d o{W h y I a m k e e p d o i n g t h i s ! @ # $ % ^ & * ( ) 3 s h o u l e n u f ?".split("{"),
b=[];for(a=0;100>a;a++)b[a]=new createjs.Text(d[Math.floor(Math.random()*(d.length+1))],"4px arial",createjs.Graphics.getRGB(0,Math.floor(180+75*Math.random()),Math.floor(50*Math.random()))),b[a].lineWidth=8,b[a].textAlign="center",b[a].y=758,b[a].x=0==a%2?300*Math.random()-30:700+324*Math.random(),this.scene.addChild(b[a]),createjs.Tween.get(b[a],{loop:!0}).to({y:-200},Math.floor(1E4+5E3*Math.random())).addEventListener("change",function(a){a.target.target.text=d[Math.floor(Math.random()*d.length)]});
stage.addChild(this.scene)},erase:function(a){a.removeChild(this.scene)}};function Graph(a){this.machines=a.machines;this.services=a.services;this.paths=a.paths;this._mDict=[];this._sDict=[];this._pDict=[];for(var b=0;b<a.machines.length;b++){var c=a.machines[b];this._mDict[c.machineID]=c}for(b=0;b<a.services.length;b++)c=a.services[b],this._sDict[c.serviceID]=c,c.impact=c.impact||{a:0,c:0,i:0};for(b=0;b<a.paths.length;b++)c=a.paths[b],this._mDict[c.pathID]=c;this._sDict[0]={serviceID:0,name:"os",machineID:0,captured:!0}};var LevelScene={scene:null,mapList:null,load:function(a){function b(){createjs.Sound.play("click-sfx");SceneManager.changeScene(PlayScene,{mapID:this.urlsafekey})}function c(){createjs.Sound.play("hover-sfx");this.bbg.graphics.clear().s("#6DEAFF").f("#C8F8FF").r(-500,-15,1E3,30).ef().es()}function d(){this.bbg.graphics.clear().s("#6DEAFF").f("#008CA4").r(-500,-15,1E3,30).ef().es()}a=callAPI("GET","/maplist");this.mapList=JSON.parse(a);this.scene=new createjs.Container;createjs.Sound.play("level-bgm",
{loop:-1});a=new createjs.Text("MAP SELECT","36px arial","#FFF");a.textAlign="center";a.x=512;this.scene.addChild(a);a=[];for(var e=0;e<this.mapList.length;e++){a[e]=new createjs.Container;a[e].bbg=new createjs.Shape;a[e].bbg.graphics.clear().s("#6DEAFF").f("#008CA4").r(-500,-15,1E3,30).ef().es();a[e].addChild(a[e].bbg);var f=new createjs.Text(this.mapList[e].name,"18px arial","#FFF");a[e].urlsafekey=this.mapList[e].key;f.textAlign="center";f.y=-10;a[e].addChild(f);a[e].x=512;a[e].y=60+40*e;a[e].on("click",
b,a[e]);a[e].on("mouseover",c,a[e]);a[e].on("mouseout",d,a[e]);this.scene.addChild(a[e])}stage.addChild(this.scene);SceneManager.currentScene=this},erase:function(a){a.removeChild(this.scene)}};var PreloadScene={scene:null,load:function(){this.scene=new createjs.Container;var a=new createjs.Shape;this.scene.addChild(a);a.graphics.f("green").r(412,300,0,30);(new createjs.Shape).graphics.f("yellow").r(412,450,0,30);myItems={};var b=new createjs.LoadQueue;createjs.Sound.alternateExtensions=["mp3"];b.installPlugin(createjs.Sound);b.loadManifest([{src:"resource/bg/bg-city.png",id:"bg-city"},{src:"resource/bg/bg-grass.png",id:"bg-grass"},{src:"resource/bg/bg-mountain1.png",id:"bg-mt1"},{src:"resource/bg/bg-mountain2.png",
id:"bg-mt2"},{src:"resource/bg/help2.png",id:"help"},{src:"resource/char/char-city.png",id:"char-city"},{src:"resource/char/char-flag.png",id:"char-flag"},{src:"resource/char/char-scout.png",id:"char-scout"},{src:"resource/char/char-sol1.png",id:"char-sol1"},{src:"resource/char/char-tank.png",id:"char-tank"},{src:"resource/sfx/FiveArmies.mp3",id:"level-bgm",data:1},{src:"resource/sfx/Hitman.mp3",id:"play-bgm",data:1},{src:"resource/sfx/DeepHaze.mp3",id:"end-bgm",data:1},{src:"resource/sfx/click.mp3",
id:"click-sfx"},{src:"resource/sfx/hover.mp3",id:"hover-sfx"},{src:"resource/sfx/begin.wav",id:"start-sfx"},{src:"resource/sfx/complete.wav",id:"end-sfx"}],"/static/game/");b.on("progress",function(b){a.graphics.clear().f("green").r(412,300,200*b.loaded,30)},this);b.on("fileload",function(a){myItems[a.item.id]=a.result},this);b.on("complete",function(a){SceneManager.changeScene(LevelScene,null)},this);stage.addChild(this.scene);SceneManager.currentScene=this},erase:function(a){a.removeChild(this.scene)}};QueueList={Init:function(a){QueueList.container=new createjs.Container;QueueList.names=[];QueueList.remTurns=[];var b=new createjs.Graphics;b.f("rgba(0,0,0,0.5)").rr(0,0,130,400,15).ef();QueueList.container.addChild(new createjs.Shape(b));QueueList.container.y=100;QueueList.container.x=-100;a.addChild(QueueList.container);QueueList.container.on("mouseover",function(){createjs.Tween.get(QueueList.container).to({x:0},200)},this);QueueList.container.on("mouseout",function(){createjs.Tween.get(QueueList.container).to({x:-100},
200)},this)},Add:function(a,b){var c=new createjs.Text(a,"18px arial","#FFFFFF");QueueList.names.push(c);QueueList.container.addChild(c);var d=new createjs.Text(b,"18px arial","#FFFFFF");d.x=100;QueueList.remTurns.push(d);QueueList.container.addChild(d);for(var e=!1,f=0;f<QueueList.names.length;f++)QueueList.remTurns[f].text!=b||e?parseInt(QueueList.remTurns[f].text,10)>=b&&e&&(QueueList.names[f].y+=30,QueueList.remTurns[f].y+=30):(c.y=30*f,d.y=30*f,e=!0)},Remove:function(a){for(var b=0;b<QueueList.names.length;b++)if(null==
a&&0==QueueList.remTurns[b].text){QueueList.container.removeChild(QueueList.names[b]);QueueList.container.removeChild(QueueList.remTurns[b]);for(var c=b;c<QueueList.names.length;c++)QueueList.names[c].y-=30,QueueList.remTurns[c].y-=30;QueueList.remTurns.splice(b,1);QueueList.names.splice(b,1);--b}}};var SceneManager={currentScene:null,changeScene:function(a,b){this.currentScene&&(this.currentScene.erase(stage),createjs.Sound.stop());a.load(b);this.currentScene=a}};function Soldier(a){this.edge=a;this.vector=a.gained_access;this.level=a.access_complexity;this.authen=a.authentication;this.confident=a.confidentiality_impact;this.integrity=a.integrity_impact;this.availability=a.availability_impact;this.score=(this.vector+this.level+this.authen+this.confident+this.integrity+this.availability-1)/6;this.name=RANDOM_NAME[a.pathID];this.op=a.name||"unknown";this.from=PlayScene.graph._sDict[a.src].machineID;this.to=PlayScene.graph._sDict[a.dest].machineID;this.pathId=
a.pathID;this.cve_id=a.cve_id}
Soldier.prototype.Draw=function(a,b,c){var d;d=1>this.score?{images:[myItems["char-sol1"]],frames:{width:63,height:57,regX:32,regY:28,count:20},animations:{"default":[0,19,"default",.75]}}:{images:[myItems["char-tank"]],frames:{width:94,height:53,regX:47,regY:27,count:12},animations:{"default":[0,11,"default",.75]}};null!=a&&(this.sheet=new createjs.SpriteSheet(d),this.sprite=new createjs.Sprite(this.sheet,"default"),this.sprite.x=b,this.sprite.y=c,this.sprite.scaleX=1.5,this.sprite.scaleY=1.5,this.sprite.ref=
this,a.addChild(this.sprite),this.sprite.gotoAndStop("default"))};
Soldier.Action=function(a){a=a.target;if(PlayScene.graph._sDict[a.ref.edge.src].captured){createjs.Sound.play("start-sfx");var b=PlayScene.graph._sDict[a.ref.to],c=SCORE_SYSTEM.av[a.ref.vector],c=c+SCORE_SYSTEM.ac[a.ref.level],c=c+SCORE_SYSTEM.au[a.ref.authen],c=c+SCORE_SYSTEM.ai[Math.max(0,a.ref.availability-b.impact.a)],c=c+SCORE_SYSTEM.ii[Math.max(0,a.ref.integrity-b.impact.i)],c=c+SCORE_SYSTEM.ci[Math.max(0,a.ref.confident-b.impact.c)],b={start:parseInt(PlayScene.turnText.text,10),soldier:a.ref,
dur:3,ci:a.ref.confident,ii:a.ref.integrity,ai:a.ref.availability,score:c,cve_id:0};a.ref.edge.status="using";c=PlayScene.graph._mDict[PlayScene.graph._sDict[a.ref.edge.dest].machineID];c.status="attacking";c.atkCount+=1;a.ref.Draw(PlayScene.cityMap.symbolLayer,PlayScene.cursor.x,PlayScene.cursor.y);a.ref.sprite.gotoAndPlay("default");QueueList.Add(a.ref.name,b.dur);PlayScene.atkQueue.push(b);ActionPane.container.removeAllChildren()}else PlayScene.comment.text="I can't attack from here."};
Soldier.ShowInfo=function(a){a=a.target;createjs.Sound.play("hover-sfx");PlayScene.stat.text="name: "+a.ref.name+"\nlevel: "+a.ref.level+"\nkey: "+a.ref.edge.keyHeld+"/"+a.ref.authen+"\noccupiable: "+a.ref.confident+"\ncapacity: "+a.ref.integrity+"\ndamage: "+a.ref.availability+"\n"};function Explorer(a){this.name="explorer";this.city=a;this.level=2;this.op="scan";this.from=0;this.to=a.machine.machineID}
Explorer.prototype.Draw=function(a,b,c){null!=a&&(this.sheet=new createjs.SpriteSheet({animations:{"default":[0,3,"default"]},images:[myItems["char-scout"]],frames:{width:128,height:46,regX:64,regY:23,count:4}}),this.sprite=new createjs.Sprite(this.sheet,"default"),this.sprite.x=b,this.sprite.y=c-64,this.sprite.ref=this,this.sprite.gotoAndPlay("default"),this.scan0=new createjs.Bitmap("resource/fx/scan0.png"),this.scan0.x=b,this.scan0.y=c,this.scan0.regX=this.scan0.regY=32,a.addChild(this.scan0),
this.scan1=new createjs.Bitmap("resource/fx/scan1.png"),this.scan1.x=b,this.scan1.y=c,this.scan1.regX=32,this.scan1.regY=32,a.addChild(this.scan1),a.addChild(this.sprite),createjs.Tween.get(this.sprite,{loop:!0}).to({rotation:10},1E3).to({rotation:-10},2E3).to({rotation:0},1E3),createjs.Tween.get(this.scan1,{loop:!0}).to({rotation:360},4E3))};
Explorer.prototype.Erase=function(){createjs.Tween.get(this.sprite,{override:!0}).to({scaleX:.01,scaleY:.01},500,createjs.Ease.backIn);createjs.Tween.get(this.scan0).to({scaleX:1.5,scaleY:1.5,alpha:0},500);createjs.Tween.get(this.scan1,{override:!0}).to({scaleX:1.5,scaleY:1.5,alpha:0},500).call(function(){createjs.Tween.removeTweens(this.sprite);createjs.Tween.removeTweens(this.scan1);createjs.Tween.removeTweens(this.scan0);PlayScene.worldMap.removeChild(this.scan1);PlayScene.worldMap.removeChild(this.scan0);
PlayScene.worldMap.removeChild(this.sprite)},null,this)};Explorer.ShowInfo=function(a){createjs.Sound.play("hover-sfx");a=a.target;PlayScene.stat.text="name: "+a.ref.name+"\ncity: "+a.ref.city.name+"\n"};
Explorer.Action=function(a){a=a.target;var b={start:parseInt(PlayScene.turnText.text,10),soldier:a.ref,dur:2,ai:0,ci:0,ii:0,score:5,cve_id:0};a.ref.city.machine.status="using";var c=a.ref.city.machine;c.status="attacking";c.atkCount+=1;QueueList.Add(a.ref.name,b.dur);PlayScene.atkQueue.push(b);ActionPane.container.removeAllChildren();a.ref.Draw(PlayScene.worldMap,PlayScene.cursor.x,PlayScene.cursor.y)};function Picklocker(){this.name="Picklocker";this.op="Brute-force password cracking"}
Picklocker.prototype.Draw=function(a,b,c){null!=a&&(this.sheet=new createjs.SpriteSheet({animations:{"default":[0,0,"default"],picking:[1,6,"picking",.25],success:{frames:[1,8],next:null,speed:.25},fail:{frames:[1,7],next:null,speed:.25}},images:["resource/char/char-picklock.png"],frames:{width:64,height:64,regX:32,regY:32,count:9}}),this.sprite=new createjs.Sprite(this.sheet,"picking"),this.sprite.x=b,this.sprite.y=c,this.sprite.ref=this,a.addChild(this.sprite))};
function addStep(a){getCookie("user_id");callAPI("POST","/add-step","waypoint="+PlayScene.wayKey+"&startTurn="+a.start+"&dur="+a.dur+"&endTurn="+(a.start+a.dur)+"&solType="+a.soldier.op+"&cost="+a.soldier.level+"&pathID="+(a.soldier.pathId||0)+"&from="+a.soldier.from+"&to="+a.soldier.to+"&ci="+a.ci+"&ai="+a.ai+"&ii="+a.ii+"&score="+a.score+"&cve_id="+a.soldier.cve_id)};function Vector(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0}
Vector.prototype={negative:function(){return new Vector(-this.x,-this.y,-this.z)},add:function(a){return a instanceof Vector?new Vector(this.x+a.x,this.y+a.y,this.z+a.z):new Vector(this.x+a,this.y+a,this.z+a)},subtract:function(a){return a instanceof Vector?new Vector(this.x-a.x,this.y-a.y,this.z-a.z):new Vector(this.x-a,this.y-a,this.z-a)},multiply:function(a){return a instanceof Vector?new Vector(this.x*a.x,this.y*a.y,this.z*a.z):new Vector(this.x*a,this.y*a,this.z*a)},divide:function(a){return a instanceof
Vector?new Vector(this.x/a.x,this.y/a.y,this.z/a.z):new Vector(this.x/a,this.y/a,this.z/a)},equals:function(a){return this.x==a.x&&this.y==a.y&&this.z==a.z},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a){return new Vector(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,
this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(a){return[this.x,this.y,this.z].slice(0,a||3)},clone:function(){return new Vector(this.x,this.y,this.z)},init:function(a,b,c){this.x=a;this.y=b;this.z=c;return this}};Vector.negative=function(a,b){b.x=-a.x;b.y=-a.y;b.z=-a.z;return b};Vector.add=function(a,b,c){b instanceof Vector?(c.x=a.x+b.x,c.y=a.y+b.y,c.z=a.z+b.z):(c.x=a.x+b,c.y=a.y+b,c.z=a.z+b);return c};
Vector.subtract=function(a,b,c){b instanceof Vector?(c.x=a.x-b.x,c.y=a.y-b.y,c.z=a.z-b.z):(c.x=a.x-b,c.y=a.y-b,c.z=a.z-b);return c};Vector.multiply=function(a,b,c){b instanceof Vector?(c.x=a.x*b.x,c.y=a.y*b.y,c.z=a.z*b.z):(c.x=a.x*b,c.y=a.y*b,c.z=a.z*b);return c};Vector.divide=function(a,b,c){b instanceof Vector?(c.x=a.x/b.x,c.y=a.y/b.y,c.z=a.z/b.z):(c.x=a.x/b,c.y=a.y/b,c.z=a.z/b);return c};Vector.cross=function(a,b,c){c.x=a.y*b.z-a.z*b.y;c.y=a.z*b.x-a.x*b.z;c.z=a.x*b.y-a.y*b.x;return c};
Vector.unit=function(a,b){var c=a.length();b.x=a.x/c;b.y=a.y/c;b.z=a.z/c;return b};Vector.fromAngles=function(a,b){return new Vector(Math.cos(a)*Math.cos(b),Math.sin(b),Math.sin(a)*Math.cos(b))};Vector.randomDirection=function(){return Vector.fromAngles(Math.random()*Math.PI*2,Math.asin(2*Math.random()-1))};Vector.min=function(a,b){return new Vector(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.min(a.z,b.z))};Vector.max=function(a,b){return new Vector(Math.max(a.x,b.x),Math.max(a.y,b.y),Math.max(a.z,b.z))};
Vector.lerp=function(a,b,c){return b.subtract(a).multiply(c).add(a)};Vector.fromArray=function(a){return new Vector(a[0],a[1],a[2])};